

## Исправление критических багов в APLink

Исправляем 4 взаимосвязанные проблемы:
1. **"Rendered more hooks than during the previous render"** — React падает из-за нарушения правил хуков
2. **"Что-то пошло не так" при создании звонка** — последствие вышеуказанной ошибки
3. **Вылет в "старую версию" после завершения звонка** — браузерный кэш + crash recovery
4. **Общая нестабильность мобильной версии** — следствие первых трёх проблем

---

## Причина проблемы

В `MeetingRoom.tsx` строка 124 содержит ранний return:
```typescript
if (!roomId) return null;  // ← ПРОБЛЕМА
```

Этот return находится **после** хуков на строках 85-119, но **перед** хуками на строках 132-178+. Когда пользователь переходит в комнату или выходит из неё, React может увидеть разное количество хуков в разных рендерах, что вызывает критическую ошибку.

Дополнительно, при crash приложение показывает ErrorBoundary с сообщением "Что-то пошло не так", а после reload браузер может загрузить закэшированную старую версию.

---

## Что исправим

### 1. Перемещение раннего return в начало компонента MeetingRoom

Ранний return `if (!roomId) return null` должен быть **ДО всех хуков**, либо все хуки должны быть вызваны **ДО** этой проверки.

Оптимальное решение: переместить проверку `roomId` в самое начало, до любых useState/useRef/useEffect, и сделать "безопасный" компонент-обёртку.

### 2. Добавление агрессивного cache-busting при критических ошибках

При падении компонента (ErrorBoundary) и при выходе из звонка добавим принудительную очистку кэша и перезагрузку свежей версии.

### 3. Улучшение ErrorBoundary для более корректного восстановления

После ошибки "Rendered more hooks" добавим автоматический редирект на `/__refresh` для полной перезагрузки.

### 4. Защита от кэширования старых версий

Добавим Service Worker unregistration и cache invalidation при критических ошибках.

---

## Детали изменений

### Файл: `src/pages/MeetingRoom.tsx`

**Проблема:** Ранний return на строке 124 нарушает правила React hooks.

**Решение:** Создаём безопасную обёртку-компонент, которая проверяет `roomId` ДО рендеринга основного компонента с хуками:

```typescript
// Внешний компонент-обёртка без хуков (кроме useParams)
function MeetingRoomGuard() {
  const { roomId } = useParams();
  const navigate = useNavigate();
  
  // Безопасная проверка ДО любых других хуков
  if (!roomId) {
    // Редирект на главную вместо return null
    useEffect(() => {
      navigate('/', { replace: true });
    }, []);
    return <LoadingScreen />;
  }
  
  // Передаём roomId как prop, гарантируя его существование
  return <MeetingRoomContent roomId={roomId} />;
}

// Основной компонент с хуками — roomId гарантированно string
function MeetingRoomContent({ roomId }: { roomId: string }) {
  // Все хуки теперь безопасны — roomId всегда определён
  // ...existing code...
}
```

### Файл: `src/components/ErrorBoundary.tsx`

**Улучшения:**
1. Обнаружение ошибки "Rendered more hooks" и автоматический редирект на `/__refresh`
2. Добавление cache-busting query параметра при перезагрузке
3. Очистка Service Worker кэша при критических ошибках

### Файл: `src/main.tsx`

**Улучшения:**
1. При старте приложения — проверка и очистка устаревших Service Workers
2. Добавление версионного тега для отслеживания билдов

### Файл: `src/pages/Refresh.tsx`

**Улучшения:**
1. Принудительная очистка всех кэшей (localStorage partial, sessionStorage, caches API)
2. Unregister Service Workers перед редиректом

---

## Техническая часть

### Исправление hook ordering в MeetingRoom.tsx

```text
БЫЛО:
┌──────────────────────────────┐
│ useParams, useState (×10)    │ ← хуки
│ useRef (×7)                  │ ← хуки  
│ useAuth, usePushNotifications│ ← хуки
│ useEffect (×2)               │ ← хуки
│ useConnectionSounds, etc.    │ ← хуки
│ useActiveCall                │ ← хук
├──────────────────────────────┤
│ if (!roomId) return null;    │ ← CRASH POINT
├──────────────────────────────┤
│ useEffect (×5+)              │ ← эти хуки не вызываются
│                              │   если roomId = undefined
└──────────────────────────────┘

СТАНЕТ:
┌──────────────────────────────┐
│ MeetingRoomGuard()           │
│   └─ useParams               │
│   └─ if (!roomId) → redirect │ ← безопасный early exit
└──────────────────────────────┘
              ↓
┌──────────────────────────────┐
│ MeetingRoomContent(roomId)   │
│   └─ все хуки (×20+)         │ ← гарантированно вызываются
│   └─ вся логика              │   в одном порядке
└──────────────────────────────┘
```

### Cache-busting стратегия

При обнаружении критической ошибки или при завершении звонка:
1. Очищаем sessionStorage ключи, связанные с call state
2. Вызываем `caches.delete()` для Service Worker кэшей
3. Unregister все Service Workers
4. Редирект через `/__refresh?to=/&__cb=timestamp`

---

## Ожидаемый результат

1. **Ошибка "Rendered more hooks"** — полностью устранена
2. **"Создать звонок" работает** — комната открывается без crash
3. **После завершения звонка** — редирект на актуальную версию без отката
4. **Мобильная версия** — стабильная работа без crash/reload циклов

---

## Затронутые файлы

1. `src/pages/MeetingRoom.tsx` — разделение на Guard + Content
2. `src/components/ErrorBoundary.tsx` — улучшенное восстановление
3. `src/main.tsx` — cache cleanup при старте
4. `src/pages/Refresh.tsx` — полная очистка кэшей
5. `src/utils/globalErrorHandler.ts` — фильтрация hook errors

---

## Риски и митигация

- **Риск:** Разделение MeetingRoom на 2 компонента может затронуть state management
  - **Митигация:** Все props передаются явно, context остаётся доступным
  
- **Риск:** Агрессивная очистка кэша может замедлить загрузку
  - **Митигация:** Очистка только при критических ошибках, не при каждом визите

