

# План: Исправление проблем мобильной версии APLink

## Обнаруженные проблемы

### 1. Двойной экран при нажатии "Создать" (видно на скриншоте)

**Причина**: На главной странице (Index.tsx) форма создания комнаты и ProfileCard имеют одинаковый стиль:
- `border border-primary/40` (яркая тело-циановая граница)
- `animate-glass-shine` — бегущий блик
- `bg-gradient-to-br from-primary/10 via-primary/5 to-primary/15` — градиентный оверлей

Когда пользователь авторизован, он видит ОБЕ карточки на экране: форму создания комнаты И ProfileCard ниже. Каждая из них имеет двойные обводки (внешняя primary/40 + внутренний градиентный overlay), что создаёт эффект "двойных линий".

**Решение**:
1. Убрать яркую обводку `border-primary/40` на мобильных, заменив на более тёмную `border-white/10`
2. Уменьшить насыщенность градиентных оверлеев на мобильных
3. Притушить `animate-glass-shine` на мобильных (или убрать вообще)

---

### 2. Слишком яркий интерфейс на мобильных

**Причина**: Множество элементов используют:
- `border-primary/40`, `border-primary/30` — яркие тёловые обводки
- Градиенты с high opacity (`from-primary/20`, `via-primary/10`)
- Агрессивные `shadow-[0_8px_32px_rgba(6,182,212,0.15)]`
- `animate-pulse-glow` на кнопках

**Решение**:
1. В `src/pages/Index.tsx`:
   - Заменить `border-primary/40` → `border-white/15 md:border-primary/40`
   - Убрать или притушить `animate-glass-shine` на мобильных (добавить `.sm:animate-glass-shine`)
   - Уменьшить насыщенность градиентов для мобильных

2. В `src/components/ProfileCard.tsx`:
   - Аналогичные изменения для консистентности

3. В `src/components/APLinkBottomNav.tsx`:
   - Уменьшить яркость glow эффектов у иконки "Создать"
   - Убрать `animate-pulse-glow` или сделать его более тонким

---

### 3. Переподключения в мобильной версии комнаты

**Причина**: iOS Safari и мобильные браузеры чувствительны к:
- Simulcast (несколько видео-потоков)
- High-resolution video (1080p на слабом железе)
- VP9 codec (не поддерживается на iOS Safari)

**Текущее решение уже есть** — код в `LiveKitRoom.tsx` автоматически включает iOS Safe Mode (`detectIsIOSOrMobileSafari()`):
- VP8 codec
- 540p resolution
- 20fps
- Без simulcast

**Дополнительные улучшения**:
1. Убедиться, что iOS Safe Mode корректно определяется
2. Добавить более агрессивную деградацию для слабых мобильных устройств

---

### 4. Микрофон/камера не включаются на мобильных

**Причина**: По Web Media Capture правилам, `getUserMedia()` ДОЛЖЕН вызываться напрямую из user-gesture handler (tap event). Если вызов асинхронно отложен или обёрнут в промис — браузер блокирует доступ.

**Решение**:
1. В `LiveKitRoom.tsx` убедиться, что камера/микрофон активируются синхронно по клику
2. Текущая реализация уже использует кнопки с прямыми обработчиками — проверить что они не wrapped в async без user gesture

---

### 5. Автоматическая запись включается без спроса

**Причина**: В `MeetingRoom.tsx` логика `autoStartRecording()` вызывается при `onConnected`:
```typescript
if (!autoRecordEnabled) {
  setShowManualRecordPrompt(true);
  return;
}
// else начинает запись
```

Но `showManualRecordPrompt` всплывает как уведомление, и если пользователь ничего не делает, оно исчезает через 10 секунд. Проблема: пользователь на мобильном может не успеть среагировать.

**Решение**:
1. Убедиться что по умолчанию `auto_record_enabled = false` (уже так)
2. Увеличить время отображения промта до 15-20 секунд на мобильных
3. Сделать промт более заметным на мобильных

---

### 6. Окно чата слишком большое на мобильных

**Причина**: В `InCallChat.tsx` высота для мобильных — `h-[70vh]`:
```tsx
isMobile 
  ? "inset-x-0 bottom-0 h-[70vh] rounded-t-[1.5rem] animate-slide-up" 
```

70% viewport height — слишком много для мобильного.

**Решение**:
1. Уменьшить высоту мобильного чата до `h-[50vh]` или `max-h-[400px]`

---

## Файлы для изменения

### 1. `src/pages/Index.tsx`
- Смягчить яркость обводок формы на мобильных
- Уменьшить насыщенность градиентов
- Опционально: убрать `animate-glass-shine` на мобильных

### 2. `src/components/ProfileCard.tsx`
- Аналогичные изменения для единообразия

### 3. `src/components/APLinkBottomNav.tsx`
- Уменьшить яркость glow эффектов на кнопке "Создать"

### 4. `src/components/InCallChat.tsx`
- Уменьшить высоту мобильного чата с `h-[70vh]` до `h-[50vh]`

### 5. `src/pages/MeetingRoom.tsx`
- Увеличить время отображения промта записи на мобильных

---

## Техническая схема изменений

```text
┌─────────────────────────────────────────────────────────────┐
│ ПРОБЛЕМА: Двойные линии и яркость на мобильных             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Сейчас:                   После:                           │
│ ┌────────────────────┐    ┌────────────────────┐            │
│ │ border-primary/40  │    │ border-white/15    │  (мобильн)│
│ │ glow-эффекты       │ -> │ нет glow           │  (мобильн)│
│ │ animate-glass-shine│    │ нет shine          │  (мобильн)│
│ └────────────────────┘    └────────────────────┘            │
│                                                             │
│ Desktop: оставить яркие эффекты                            │
│ Mobile: приглушенная, тёмная тема                          │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ ПРОБЛЕМА: Чат занимает 70% экрана                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Сейчас:          После:                                    │
│ h-[70vh]    ->   h-[50vh] max-h-[400px]                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Ожидаемый результат

1. **Нет двойных линий**: Формы на главной странице будут иметь тонкие тёмные границы на мобильных
2. **Менее яркий интерфейс**: Glow и shine эффекты отключены или приглушены на мобильных
3. **Чат удобного размера**: Занимает 50% экрана, не блокируя видео
4. **Запись по умолчанию выключена**: Промт остаётся дольше, давая пользователю время решить
5. **Камера/микрофон**: Сохранить существующую логику прямого вызова getUserMedia по клику

