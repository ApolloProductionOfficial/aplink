
## Контекст и диагноз (по коду)
### 1) Почему падает “Rendered more hooks…”
В `src/pages/MeetingRoom.tsx` прямо сейчас есть **ранний `return` между хуками**:

- `if (!roomId) return null;` стоит на строке ~124 **после** большого набора хуков (`useState/useRef/useEffect/useActiveCall/...`) и **до** следующих хуков (`useEffect` регистрации звонка, setEventHandlers, usePresence и т.д.).
- Дальше в файле есть ещё один ранний `return`:
  - `if (!userName) return null;` на строке ~711 **до** `useEffect` на строке ~892.
- Также есть `navigate(...)` **внутри рендера** при `!userName` (строка ~418), что в dev/StrictMode и при быстрых переходах может давать “полурендеры” и усиливать проблему.

Это и есть прямое нарушение правила React hooks: количество/порядок хуков должно быть одинаковым на каждом рендере.

### 2) Почему “Создать комнату” показывает ErrorBoundary (“Что-то пошло не так”)
Это не отдельная ошибка “создания комнаты” — это **последствие краша React** (вылет по hooks), после которого срабатывает `ErrorBoundary` и ты видишь общий экран “Что-то пошло не так”.

### 3) Почему после завершения звонка иногда “откатывает” на старый дизайн
С высокой вероятностью это комбинация:
- краш/перезагрузка → браузер/вебвью (особенно Telegram/Safari/WebKit) может отдать **закэшированный** старый `index.html`/бандл,
- отсутствует “жёсткий” сценарий восстановления, который гарантированно перегружает приложение с cache-bust (у нас `/__refresh` пока делает только `__cb`, без чистки caches/SW).

---

## Цель изменений
1) Полностью устранить “Rendered more hooks than during the previous render” в `MeetingRoom`.
2) Убрать “Что-то пошло не так” при “Создать комнату” (как следствие фикса пункта 1).
3) Сделать “одну единую актуальную версию”: при критических ошибках и в чувствительных точках (выход из звонка) принудительно грузить свежий билд через `/__refresh` + расширенный cache-busting.
4) Стабилизировать мобильный UX за счёт устранения крашей + контрольного прогона мобильных сценариев после фикса.

---

## План работ (что именно меняем)

### A. Починить hook-order в `MeetingRoom.tsx` (ключевой фикс)
**Файл:** `src/pages/MeetingRoom.tsx`

#### A1) Вынести проверки `roomId` и `name` в “Guard”-обёртку
Сделаем “тонкий” компонент-обёртку (Guard), который:
- читает `roomId` и `name`,
- если данных нет — делает **безопасный редирект** и рендерит “Перенаправление…”
- если всё ок — рендерит `MeetingRoomContent` и передаёт туда `roomId` и `userName` как гарантированные строки.

Важно: в Guard **нельзя** вызывать хуки условно. Поэтому:
- `useEffect` (если нужен) вызывается **всегда**, а внутри него делаем `if (!roomId) ...`, `if (!userName) ...`.
- либо ещё проще: использовать `<Navigate replace to="..."/>` для редиректа без эффектов.

#### A2) `MeetingRoomContent` содержит всю текущую логику и все хуки
- Перенесём туда весь текущий код MeetingRoom (большую часть файла), но:
  - удалим `if (!roomId) return null;`
  - удалим оба блока `if (!userName) ... return ...` и `if (!userName) return null;`
  - уберём `navigate(...)` из тела рендера (это будет делать Guard).

Результат: `MeetingRoomContent` всегда монтируется только когда параметры валидны, и **внутри него порядок хуков стабилен**.

#### A3) Проверим, что после удаления ранних return’ов в MeetingRoomContent не осталось хуков ниже условных return’ов
Сделаем ревизию: “все `useState/useRef/useEffect/useXxx()` — только вверху/до любых `return`”.

---

### B. Усилить восстановление при падении React (ErrorBoundary → /__refresh)
**Файл:** `src/components/ErrorBoundary.tsx`

#### B1) Детектим hook-crash в проде и деве
Сейчас в логах есть:
- “Rendered more hooks…”
- и “Minified React error #310 … invariant=310 …” (в прод-сборке)

Добавим детектор, который считает “критическим”:
- `Rendered more hooks than during the previous render`
- `Rendered fewer hooks than expected`
- `Minified React error #310` (и/или наличие `invariant=310` в stack)

#### B2) Авто-редирект на `/__refresh` один раз за сессию
По аналогии с уже существующим механизмом для TooltipProvider:
- заводим ключ в `sessionStorage`, например `aplink_hook_reload_attempted`
- если ключа нет → ставим ключ и делаем:
  - `window.location.replace(/__refresh?to=<currentPath>&t=Date.now())`

Это резко снижает шанс “залипания” на старом закэшированном билде после краша.

#### B3) UI-кнопка “Обновить свежую версию”
На экране ошибки вместо обычного `window.location.reload()` добавим кнопку, которая ведёт через `/__refresh` (это важнее для WebView/мобильных случаев).

---

### C. Сделать `/__refresh` реально “жёстким” (cache-busting)
**Файл:** `src/pages/Refresh.tsx`

Сейчас `/__refresh` только добавляет `__cb` и делает `location.replace`, но:
- не чистит Cache Storage API,
- не пытается unregister service workers (даже если вдруг есть),
- не делает “жёсткую” подготовку к свежей загрузке.

#### C1) Перед редиректом выполнить:
- `navigator.serviceWorker.getRegistrations()` → `unregister()` (если доступно)
- `caches.keys()` → `caches.delete(key)` (если доступно)

Важно: **не трогаем `localStorage` целиком**, чтобы не разлогинить пользователя и не потерять важные данные (сессия, восстановление записи и т.п.). `sessionStorage` тоже лучше чистить точечно или не чистить вовсе — минимум: ключи, связанные с “reload attempted”.

#### C2) После очистки делаем `window.location.replace(target + __cb=timestamp)`
Это увеличит шанс, что приложение подхватит **самый свежий `index.html`/бандл**.

---

### D. Убрать “откат в старую версию” после завершения звонка (через refresh flow)
**Файлы (минимально):**
- `src/pages/MeetingRoom.tsx` (места, где мы уходим на `/` или `/dashboard` после завершения)
- опционально: `src/components/GlobalActiveCall.tsx` (если нужен единый централизованный выход)

#### D1) В точках выхода из звонка использовать переход через `/__refresh`
Например, когда пользователь нажимает “Выйти/Завершить” и мы уходим на `/` или `/dashboard`, делаем:
- `navigate('/__refresh?to=/dashboard', { replace: true })`
или
- `window.location.replace('/__refresh?to=/dashboard&t=...')`

Так мы гарантируем, что после звонка человек не увидит “старую” закэшированную версию.

Мы сделаем это **селективно** (только на выход из звонка / после критических ошибок), чтобы не замедлять обычную навигацию.

---

### E. Мобильная “идеальность”: что именно будем проверять и править после фикса крашей
После A–D мобильная версия станет заметно стабильнее просто потому, что перестанет падать React.

Дальше проведём контрольный мобильный прогон (и поправим найденное):
1) Главная (`/`): форма “Создать комнату”, ввод имени, клавиатура не закрывает кнопку, фокус/скролл.
2) В комнате (`/room/:roomId`):
   - кнопки: mic/camera/screen share/translate/cc/copy link/выход
   - состояние reconnect: блокировки, тосты, отсутствие двойных кликов/гонок
3) Минимизация/максимизация (если используется): отсутствие случайных тапов по “невидимым” слоям, корректные `z-index`/`pointer-events`.
4) Выход из звонка: переход на свежую версию (через `/__refresh`) без “старого дизайна”.

---

## Как будем проверять (тест-план)
Поскольку автоматически “отключить интернет” инструментами мы не можем так же, как руками, тест будет следующим:

1) **Имитировать потерю сети во время звонка**
- Открыть комнату.
- В DevTools → Network → Offline на 5–10 секунд → Online.
- Ожидаемое: нет краша, UI показывает reconnect, потом “Связь восстановлена”, звонок жив.

2) **Долгий звонок 15+ минут**
- Оставить комнату открытой 15–20 минут.
- Ожидаемое: нет `token expired`/401, нет принудительного вылета.

3) **Переключение камеры/микрофона**
- Быстро 5–10 раз переключить mic/camera.
- Ожидаемое: не появляется `NegotiationError` как критический сбой, нет краша React, UI не ломается.

4) **Кнопка “Создать комнату”**
- С главной создать комнату несколько раз подряд.
- Ожидаемое: нет ErrorBoundary, комната открывается стабильно.

5) **Выход из звонка**
- Нажать “Выйти”.
- Ожидаемое: переход на `/__refresh` и затем на целевую страницу без “старого дизайна”.

---

## Что именно будет затронуто (файлы)
1) `src/pages/MeetingRoom.tsx` — рефакторинг Guard + Content, устранение ранних return’ов между хуками, вынос редиректов из рендера.
2) `src/components/ErrorBoundary.tsx` — авто-восстановление при hook-crash через `/__refresh`, защита от loop’ов.
3) `src/pages/Refresh.tsx` — реальная очистка caches/SW + redirect с cache-bust.
4) (опционально, но вероятно нужно) `src/components/GlobalActiveCall.tsx` — если потребуется централизовать выход через `/__refresh` (иначе сделаем в MeetingRoom).

---

## Риски и митигация
- Риск: слишком агрессивная “чистка” может разлогинить пользователя.
  - Митигация: **не трогаем localStorage целиком**, чистим только caches/SW.
- Риск: `/__refresh` на выходе из звонка добавит лишнюю “прослойку”.
  - Митигация: использовать только на exit/critical recovery, показывать короткий “Обновление…” экран.

