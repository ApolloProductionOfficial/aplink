
# План: Удаление индикатора "Отличная связь" и исправление React Hooks ошибки

## Проблема 1: Зелёная кнопка "Отличная связь" в левом верхнем углу

### Анализ
На скриншоте видно зелёную кнопку с Wi-Fi иконкой и текстом "Отличная связь" в верхнем левом углу интерфейса звонка. 

После анализа кода найдено несколько источников:

1. **`src/components/GalleryVideoLayout.tsx`** (строки 171-191):
   - На каждой плитке участника есть индикатор качества связи
   - При наведении показывается tooltip с текстом "Отличная связь"
   - Это **нужный функционал** на плитках участников

2. **`src/pages/MeetingRoom.tsx`** (строки 986-1022):
   - `connectionIndicatorElement` рендерит только маленькую точку с tooltip
   - Это то, что должно отображаться в хедере (уже упрощено)

3. **Потенциальный источник проблемы**:
   - Возможно, старый код с кнопкой всё ещё где-то остался
   - Либо tooltip открывается и остаётся "приклеенным" к экрану

### Решение
1. Полностью убрать `connectionIndicatorElement` из `MeetingRoom.tsx` (не передавать в context)
2. Уже есть точка с tooltip рядом с таймером — этого достаточно
3. Убедиться, что tooltip использует правильные side/align для предотвращения "залипания"

---

## Проблема 2: React Hooks Error "Rendered more hooks than during the previous render"

### Анализ
Эта ошибка возникает когда:
- Хуки вызываются условно (после `if/return`)
- Количество хуков меняется между рендерами
- Компоненты с хуками условно монтируются/размонтируются

### Потенциальные источники в коде:

1. **`src/components/CaptionsOverlay.tsx`** (строки 54-123):
   - Хук `useRealtimeCaptions` вызывается на строке 67
   - Early return `if (!isEnabled) return null;` на строке 123
   - ✅ Это **корректно** — хуки вызываются ДО return

2. **`src/components/LiveKitRoom.tsx`**:
   - Компонент `LiveKitContent` содержит 15+ хуков (строки 624-700)
   - Все хуки вызываются безусловно в начале компонента
   - ✅ Это **корректно**

3. **Возможная проблема — условный рендеринг компонентов с хуками**:
   - В `LiveKitRoom.tsx` есть early returns (строки 530-559)
   - Но они происходят ПОСЛЕ всех хуков
   - ✅ Это **корректно**

4. **Реальная причина** (на основе паттерна ошибки):
   - Ошибка происходит в `/room/TEST` — это MeetingRoom
   - Проблема может быть в динамическом изменении `headerButtonsElement`
   - Или в `useEffect` с несколькими зависимостями, вызывающими каскадные ререндеры

### Решение
1. Проверить и исправить `headerButtonsElement` в MeetingRoom.tsx
2. Убедиться, что все условные компоненты не содержат хуков на верхнем уровне
3. Вынести любые условные хуки в отдельные компоненты-обёртки

---

## Файлы для изменения

### 1. `src/pages/MeetingRoom.tsx`

**Изменения:**
- Удалить `connectionIndicatorElement` полностью (строки 986-1022)
- Перестать вызывать `setConnectionIndicator()` в useEffect (строка 446)
- Это устранит дублирование и уберёт потенциально "залипающий" tooltip

### 2. `src/components/LiveKitRoom.tsx`

**Изменения:**
- Убрать рендер `connectionIndicator` в хедере (строка 1838)
- Проверить, что индикатор качества уже есть рядом с таймером в `CallTimer` или добавить его напрямую

### 3. `src/contexts/ActiveCallContext.tsx`

**Опционально:**
- Можно удалить `connectionIndicator` из контекста, если он больше не нужен

---

## Проверка на hooks safety

После изменений необходимо убедиться:
1. Все `useState`, `useRef`, `useEffect` вызываются в начале компонента
2. Нет хуков после `if (...) return`
3. Нет условных вызовов хуков типа `condition && useHook()`

---

## Техническая схема изменений

```text
До изменений (Header):
┌────────────────────────────────────────────────────────────┐
│  [Diagnostics]  Room  │  [Buttons]  │  Timer  [●tooltip]   │
│                       │             │       connectionInd. │
│  + отдельный connectionIndicatorElement где-то сбоку       │
└────────────────────────────────────────────────────────────┘

После изменений (Header):
┌────────────────────────────────────────────────────────────┐
│  [Diagnostics]  Room  │  [Buttons]  │  Timer  [●]          │
│                       │             │   ↑ tooltip на hover │
│                       │             │   с качеством связи  │
└────────────────────────────────────────────────────────────┘
```

---

## Порядок реализации

1. Удалить `connectionIndicatorElement` из MeetingRoom.tsx
2. Убрать `setConnectionIndicator()` вызов из useEffect
3. Убрать рендер `{connectionIndicator}` из LiveKitRoom.tsx хедера
4. Добавить tooltip с качеством связи на точку рядом с таймером (если ещё нет)
5. Протестировать отсутствие hooks ошибки
6. Очистить `connectionIndicator` из ActiveCallContext (опционально)

---

## Ожидаемый результат

- ✅ Зелёная кнопка "Отличная связь" больше не появляется отдельно
- ✅ Качество связи показывается через точку с tooltip рядом с таймером
- ✅ На плитках участников в Gallery mode остаётся индикатор качества (как и было)
- ✅ React hooks ошибка устранена за счёт упрощения структуры компонентов
- ✅ Интерфейс становится чище и менее нагружен дублирующими элементами
