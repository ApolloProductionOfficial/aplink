
# План: Мобильная версия и стабильность звонков

## ✅ ВЫПОЛНЕНО

### 1. Рисунок пропадает через 1-2 секунды
**Решение**: Добавлен `cancelAnimationFrame` в useEffect при смене tool (строки 411-427 DrawingOverlay.tsx). Теперь при переключении с лазера на карандаш анимационный цикл останавливается мгновенно, не успевая перезаписать рисунок.

### 2. REC включается автоматически  
**Решение**: Принудительно отключена автозапись (`autoRecordEnabled = false`) в MeetingRoom.tsx строка 232-234. Теперь запись начинается ТОЛЬКО вручную по нажатию кнопки REC.

### 3. Чат увеличивает экран (zoom) при печати
**Решение**: Изменён размер шрифта input с `text-sm` на `text-base sm:text-sm` в InCallChat.tsx строка 671. На мобильном шрифт 16px, iOS Safari не будет зумить.

### 4. Два профиля при входе с телефона (дублирующиеся участники)
**Решение**: Добавлен debounce для token fetch (минимум 1 секунда между запросами) в LiveKitRoom.tsx строки 189-192 и 218-231. Предотвращает "reconnect storm" на мобильных устройствах.

### 5. Входящие laser points игнорируются при других инструментах
**Решение**: В handleData (DrawingOverlay.tsx строки 733-738) добавлена проверка `toolRef.current === 'laser'` — если локальный инструмент не лазер, входящие точки игнорируются.

---

## Скриншоты пользователя — анализ

### Скриншот 1: Два профиля в комнате
- **Причина**: Reconnect storm на мобильном создаёт несколько token requests
- **Решение**: Debounce ✅

### Скриншот 2: "Два окошка" на главной
- **Анализ**: Это не баг — форма имеет один контейнер с glassmorphism эффектом
- На мобильном границы более тонкие (border-white/15) чем на десктопе (border-primary/40)
- Если визуально кажется что их два — это из-за gradient overlay внутри карточки

### Скриншот 3: REC и "Связь восстановлена"
- **REC**: Исправлено отключением автозаписи ✅
- **Reconnect**: Debounce должен уменьшить количество переподключений ✅
- **Камера/микрофон**: Требуется user gesture на iOS — возможно нужна кнопка "Разрешить"

---

## Оставшиеся проблемы (требуют дальнейшего исследования)

### Камера и микрофон не работают на мобильном
- Код уже содержит iOS Safe Mode с оптимизированными настройками
- Возможные причины:
  1. Разрешения не даны (нужен user gesture)
  2. Конфликт с другим приложением (Telegram in-app browser?)
  3. iOS ограничения на simulcast

### Постоянные reconnect
- Debounce добавлен, но root cause может быть в:
  1. Нестабильном мобильном интернете
  2. LiveKit server timeout settings
  3. iOS background app restrictions

---

## Файлы изменены

| Файл | Изменение |
|------|-----------|
| `src/components/DrawingOverlay.tsx` | cancelAnimationFrame + ignore incoming laser |
| `src/components/InCallChat.tsx` | text-base для mobile input |
| `src/components/LiveKitRoom.tsx` | debounce token fetch |
| `src/pages/MeetingRoom.tsx` | force autoRecordEnabled = false |
