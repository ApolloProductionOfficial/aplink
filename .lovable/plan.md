
## Что происходит сейчас (по фактам из логов)
Я посмотрел реальные ошибки за последние 2 часа в базе логов. На iPhone (iOS Safari) у тебя идут:
- `NegotiationError (code 13)` и `negotiation timed out`
- `error trying to re-publish tracks after reconnection`
- `ConnectionError Timeout` при переключении микрофона

Это как раз и даёт эффект “вылетает/залетает” и вечные переподключения: iOS Safari часто ломается при перепубликации треков (особенно если есть реконнект + попытки включить/выключить микрофон/камеру).

Параллельно по UI:
- “две камеры” внизу на скриншоте — это **камера** + **кнопка записи**, но запись сейчас обозначена иконкой `Video`, из‑за чего визуально выглядит как вторая камера. Это нужно заменить.

---

## Цели
1) Сделать соединение на телефоне (особенно iPhone/Safari) **стабильным**, убрать постоянные реконнекты/NegotiationError.
2) Дать “полную аналитику” прямо в звонке: увидеть, что происходит с сетью/треком/реконнектами, и уметь одним кликом отправить отчёт.
3) Почистить интерфейс: убрать “грязь”, уменьшить перегруз нижней панели, сделать нормальный glassmorphism и убрать “две камеры”.

---

## План работ (что именно сделаю)

### A) Стабилизация iOS (главное)
**A1. Авто “Safe Mode” для iPhone/iOS Safari**
- Определять iOS Safari по `navigator.userAgent`.
- Для iOS включать “стабильный профиль” сразу, без ожидания ошибок:
  - Кодек: **VP8** (вместо VP9)
  - Разрешение: **540p/720p**, без 1080p
  - Simulcast: **выключить** (уменьшает нагрузку/переговоры)
  - Аудио: **mono (channelCount: 1)** вместо stereo
- Это будет встроено в `roomOptions` (в `src/components/LiveKitRoom.tsx`).

**A2. Анти‑“NegotiationError” при кнопках микрофона/камеры**
- На iOS в Safe Mode переключение микрофона делать через **mute/unmute публикации**, а не через `setMicrophoneEnabled()`, чтобы не провоцировать renegotiation:
  - Если трек уже опубликован: `publication.mute()` / `publication.unmute()`
  - Если трека нет: один раз `setMicrophoneEnabled(true)` чтобы создать трек, далее только mute/unmute
- Для камеры: сделаю 2 уровня:
  - Быстрое “пауза видео” (mute/unmute) — максимально стабильно
  - “Полностью выключить камеру” (setCameraEnabled(false)) — в “Ещё”/Advanced, чтобы не триггерить лишние переговоры случайно

**A3. Эскалация при частых реконнектах**
- Внутри звонка буду считать события `RoomEvent.Reconnecting` за короткое окно (например 60 секунд).
- Если реконнекты повторяются 2–3 раза подряд:
  - Автоматически включаем Safe Mode (если ещё не включён)
  - Делаем контролируемый “force reconnect” (обновить токен + remount LKRoom) один раз, с cooldown, без спама тостами

**A4. Авто‑отключение тяжёлых эффектов при реконнекте**
- Если включён виртуальный фон/blur, при реконнекте на iOS временно отключать эффекты (они могут усугублять проблемы на Safari).
- Показывать один аккуратный toast “Отключили эффекты для стабильности”.

---

### B) “Полная аналитика” прямо в звонке (чтобы ты видел, что реально происходит)
**B1. Диагностическая панель (встроенная в UI звонка)**
Добавлю кнопку “Диагностика” (иконка Activity/Signal) и панель, где будет:
- Статус соединения: connected / reconnecting / reconnected (и счётчик реконнектов)
- Качество сети: latency/packet loss/bitrate (используем/расширяем текущий `CallQualityWidget`)
- Статус медиа:
  - включена ли камера/микрофон
  - mute/unmute состояние публикаций
  - сколько участников сейчас в комнате
- Инфо устройства/браузера:
  - iOS/Android, Safari/WebView
  - `navigator.connection` (если доступно): rtt/downlink/effectiveType
  - Permissions по mic/cam (если браузер даёт)
- Лента последних событий (последние 30–50):
  - Reconnecting/Reconnected
  - track subscribed/unsubscribed
  - попытки toggle mic/cam и их результат

**B2. Кнопка “Отправить отчёт”**
- Один клик — отправляем агрегированный диагностический пакет в backend (как “CALL_DIAGNOSTICS”), чтобы можно было открыть и понять причину.
- В отчёте будет: roomId, participantId, UA, сетевые метрики, счётчики реконнектов, последние ошибки/ивенты.
- Обязательно с троттлингом, чтобы не было спама.

Файлы: в основном `src/components/LiveKitRoom.tsx` (добавлю панель/сбор событий), возможно маленький новый компонент `CallDiagnosticsPanel.tsx` + маленький hook `useCallDiagnostics.ts`.

---

### C) Почистить интерфейс (и “две камеры”)
**C1. Убрать ощущение “две камеры”**
- В нижней панели на мобилке сейчас есть “Mobile Recording Button” с иконкой `Video` — из‑за этого выглядит как вторая камера.
- Заменю на:
  - иконку типа `Circle`/`Dot` + подпись `REC`
  - или компактный бейдж “REC” рядом
- Запись перенесу в “Ещё” на мобилке (по умолчанию), чтобы случайно не нажимали.

**C2. Упростить нижнюю панель на телефоне**
Сейчас там слишком много кнопок. На мобилке сделаю “чистую” схему:
- Камера
- Микрофон
- Чат
- Ещё (⋯) — там: раскладки, фон, рисование, реакции, запись, качество/диагностика (если не вверху)
- Выйти

**C3. Нормальный glassmorphism как в созвоне (без “грязи”)**
- Верхняя и нижняя панели сейчас `bg-transparent backdrop-blur-[2px]` — слишком “пусто” и выглядит грязно на фоне.
- Приведу к единому стилю:
  - `bg-black/35..40`
  - `backdrop-blur-2xl`
  - аккуратная рамка `border-white/10`
  - одинаковые радиусы, одинаковые тени

---

## Где именно буду менять код (основные точки)
- `src/components/LiveKitRoom.tsx`
  - iOS Safe Mode (roomOptions)
  - логика переключения mic/cam (mute/unmute на iOS)
  - счётчик реконнектов + авто‑эскалация
  - упрощение мобильной нижней панели
  - замена иконки записи (устранить “две камеры”)
  - диагностика: сбор событий/метрик + UI панель
- Возможно новые небольшие файлы (если нужно для чистоты):
  - `src/components/CallDiagnosticsPanel.tsx`
  - `src/hooks/useCallDiagnostics.ts`

---

## Как будем проверять (чек‑лист)
1) iPhone Safari: зайти в комнату, **5–10 раз** подряд:
   - включить/выключить микрофон
   - включить/выключить камеру
   - свернуть/развернуть панели
   Проверить: нет постоянных реконнектов, нет `NegotiationError`/`negotiation timed out` в логах, нет “Не удалось переключить микрофон” при нормальной сети.
2) Проверить, что нижняя панель на телефоне стала проще, и **исчезла “вторая камера”** (запись выглядит как REC, а не камера).
3) Открыть “Диагностику” в звонке и убедиться, что:
   - видно reconnect counter
   - видно сетевые метрики
   - “Отправить отчёт” отрабатывает один раз и не спамит
4) Desktop Chrome: убедиться, что HD‑режим сохранился (не ухудшили качество там, где всё ок).

---

## Риски и как их закрою
- Mute/unmute вместо выключения трека: на некоторых устройствах камера может оставаться активной. Поэтому сделаю “пауза видео (стабильно)” и “полностью выключить (privacy)” отдельно.
- Авто Safe Mode на iOS может снизить качество. Но цель сейчас — убрать “вечные реконнекты”. Дам ручной переключатель “Качество/Стабильность”.

Если ок — жми Approve, и я начну внедрение стабилизации + диагностики + чистки UI.